## 1. SSH Hardening

```bash
useradd -m -s /bin/bash sshuser
echo "sshuser:P@ssw0rd" | chpasswd
echo "PermitRootLogin no" >> /etc/ssh/sshd_config
echo "AllowUsers sshuser" >> /etc/ssh/sshd_config
systemctl restart sshd

apt install -y fail2ban
cat > /etc/fail2ban/jail.local << 'ENDCONF'
[DEFAULT]
bantime = 1m
maxretry = 2
[sshd]
enabled = true
ENDCONF
systemctl enable fail2ban
systemctl restart fail2ban 

apt install -y auditd
nano /etc/audit/rules.d/ssh.rules

-w /usr/sbin/sshd -p x -k ssh_exec
-w /etc/ssh/sshd_config -p wa -k ssh_config
systemctl restart auditd
```
fail2ban-client status sshd
ausearch -k ssh_exec


## 2. FreeIPA: Пользователи

```bash
sudo apt install -y freeipa-server freeipa-server-dns
sudo ipa-server-install --domain=reaskills.cyber --realm=REASKILLS.CYBER --setup-dns --forwarder=8.8.8.8

kinit admin

ipa group-add Administrators
ipa group-add Worker
ipa group-add TopManager

nano ~/create_users.sh

#!/bin/bash

for i in {1..40}; do
  echo -e "P@ssw0rdAdmin\nP@ssw0rdAdmin" | ipa user-add user$i --first=User --last=$i --email=user$i@reaskills.cyber --password 2>/dev/null
  ipa group-add-member Administrators --users=user$i 2>/dev/null
done

for i in {41..80}; do
  echo -e "P@ssw0rdWorker\nP@ssw0rdWorker" | ipa user-add user$i --first=User --last=$i --email=user$i@reaskills.cyber --password 2>/dev/null
  ipa group-add-member Worker --users=user$i 2>/dev/null
done

for i in {100..130}; do
  echo -e "P@ssw0rdTop\nP@ssw0rdTop" | ipa user-add superuser$i --first=SuperUser --last=$i --email=superuser$i@reaskills.cyber --password 2>/dev/null
  ipa group-add-member TopManager --users=superuser$i 2>/dev/null
done

chmod +x ~/create_users.sh
kinit admin
./create_users.sh
```
ipa group-find
ipa group-show Administrators


## 3. FreeIPA: Политика

```bash
ipa pwpolicy-mod \
  --minlength=10 \
  --minclasses=3 \
  --history=4 \
  --maxlife=31 \
  --lockouttime=900 \
  --maxfail=3
  
echo -e "Pa\$\$w0rd2026-2027\nPa\$\$w0rd2026-2027" | ipa user-add petya --first=Petya --last=Petrov --password
ipa user-mod petya --principal-expiration=20260515000000Z
```
ipa user-show petya
ipa pwpolicy-show


## 4. FreeIPA: Backup

```bash
sudo nano /usr/local/bin/freeipa-backup.sh

#!/bin/bash

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="/mnt/backup-user.backup"
PASSWORD="BackupPa\$\$"

ldapsearch -x -D "cn=Directory Manager" -w "$(cat /root/dm_password)" -b "dc=reaskills,dc=cyber" -LLL > /tmp/ldap_$DATE.ldif
tar -czf /tmp/ldap_$DATE.tar.gz /tmp/ldap_$DATE.ldif
openssl enc -aes-256-cbc -salt -pbkdf2 -in /tmp/ldap_$DATE.tar.gz -out $BACKUP_FILE -pass pass:"$PASSWORD"
rm -f /tmp/ldap_$DATE.ldif /tmp/ldap_$DATE.tar.gz

sudo chmod +x /usr/local/bin/freeipa-backup.sh
sudo crontab -e
0 2 * * * /usr/local/bin/freeipa-backup.sh
sudo /usr/local/bin/freeipa-backup.sh

nano ~/backup-restore-instructions.txt

=== КАК ВОССТАНОВИТЬ BACKUP ===

1. Расшифровать архив:
   openssl enc -aes-256-cbc -d -in /mnt/backup-user.backup -out backup.tar.gz -k "BackupPa$$"

2. Распаковать:
   tar -xzf backup.tar.gz

3. Восстановить:
   ipa-restore --data --online ipa-backup-YYYYMMDD

Пароль архива: BackupPa$$
```

## 5. XRDP (УДАЛЁННЫЙ РАБОЧИЙ СТОЛ)

```bash
# На PC1:
sudo apt install -y xrdp
sudo nano /etc/security/access.conf

+:@Administrators:ALL
+:@worker:LOCAL
-:ALL:ALL

# На PC1:
sudo nano /etc/rsyslog.d/xrdp.conf
if $programname == 'xrdp' or $programname == 'xrdp-sesman' then @@192.168.1.10:514& stop

# На MAIN-DC1 РАСКОММЕНТИРУЙ:
module(load="imudp")
input(type="imudp" port="514")
sudo systemctl restart rsyslog
```


## 6. OpenVPN

```bash
apt install -y openvpn easy-rsa

# Создать сертификаты
make-cadir ~/openvpn-ca
cd ~/openvpn-ca
./easyrsa init-pki
./easyrsa build-ca nopass
./easyrsa gen-req server nopass
./easyrsa sign-req server server
./easyrsa gen-dh
openvpn --genkey secret ta.key

# Конфиг сервера
cat > /etc/openvpn/server.conf << 'ENDCONF'
port 1194
proto udp
dev tun
ca /root/openvpn-ca/pki/ca.crt
cert /root/openvpn-ca/pki/issued/server.crt
key /root/openvpn-ca/pki/private/server.key
dh /root/openvpn-ca/pki/dh.pem
tls-auth /root/openvpn-ca/ta.key 0
server 10.8.0.0 255.255.255.0
push "route 10.10.10.0 255.255.255.0"
push "route 10.10.20.0 255.255.255.0"
cipher AES-256-GCM
persist-key
persist-tun
ENDCONF

systemctl enable openvpn@server
systemctl start openvpn@server
```


## 7. Wireguard

```bash
apt install -y wireguard
cd /etc/wireguard

# Генерация ключей
wg genkey | tee private.key | wg pubkey > public.key

# Показать публичный ключ (скопируй его!)
cat public.key

# Конфиг
cat > /etc/wireguard/wg0.conf << 'ENDCONF'
[Interface]
Address = 10.9.0.1/24
ListenPort = 51820
PrivateKey = ВСТАВЬ_СОДЕРЖИМОЕ_private.key

[Peer]
PublicKey = ВСТАВЬ_client_public.key
AllowedIPs = 10.9.0.2/32
ENDCONF

# Подставить ключ автоматически
sed -i "s|ВСТАВЬ_СОДЕРЖИМОЕ_private.key|$(cat private.key)|" /etc/wireguard/wg0.conf

systemctl enable wg-quick@wg0
systemctl start wg-quick@wg0
```

## 7. OSPF

```bash
apt install -y frr
sed -i 's/ospfd=no/ospfd=yes/' /etc/frr/daemons

# Настроить через vtysh
vtysh << 'ENDCONF'
configure terminal
router ospf
 ospf router-id 1.1.1.1
 network 10.8.0.0/24 area 0
 network 10.10.10.0/24 area 0
 exit
interface tun0
 ip ospf authentication message-digest
 ip ospf message-digest-key 1 md5 secret_key
 exit
exit
write memory
ENDCONF

systemctl restart frr
```
vtysh -c "show ip ospf neighbor"


## 8. NFTables NAT

```bash
apt install -y nftables

# NAT
nft add table ip nat
nft add chain ip nat postrouting { type nat hook postrouting priority 100 \; }
nft add rule ip nat postrouting oifname "eth0" masquerade

# Файрвол с rate limit
nft add table inet filter
nft add chain inet filter input { type filter hook input priority 0 \; policy drop \; }
nft add rule inet filter input ct state established,related accept
nft add rule inet filter input iif lo accept
nft add rule inet filter input tcp dport 22 accept
nft add rule inet filter input limit rate 100/second accept

# Сохранить
nft list ruleset > /etc/nftables.conf
systemctl enable nftables
```


## 9. NFS

На сервере (MAIN-STORAGE):

```bash
apt install -y nfs-kernel-server
mkdir -p /data
chmod 777 /data
echo "/data 192.168.3.0/24(rw,sync,no_root_squash)" >> /etc/exports
exportfs -ra
systemctl restart nfs-kernel-server
```
На клиенте (PC1):

```bash
apt install -y nfs-common
mkdir -p /mnt/home
mount 192.168.2.10:/data /mnt/home
echo "192.168.2.10:/data /mnt/home nfs defaults 0 0" >> /etc/fstab
```


## 10. Nginx HTTPS

```bash
apt install -y nginx

# Конфиг
cat > /etc/nginx/sites-available/default << 'ENDCONF'
server {
    listen 443 ssl;
    server_name www.reaskills.cyber;
    
    ssl_certificate /etc/nginx/www.crt;
    ssl_certificate_key /etc/nginx/www.key;
    
    root /data_saver;
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;
}

server {
    listen 80;
    return 301 https://$host$request_uri;
}
ENDCONF

systemctl restart nginx
```



