<html><head>

<style>
body {
    background-color: #0d1117 !important;
    color: #c9d1d9 !important;
}
html {
    background-color: #0d1117 !important;
}
h1, h2, h3, h4, h5, h6 {
    color: #58a6ff !important;
}
a {
    color: #58a6ff !important;
}
p, div, span, li, td, th {
    color: #c9d1d9 !important;
}
code {
    background-color: #161b22 !important;
    color: #79c0ff !important;
    padding: 2px 6px !important;
    border-radius: 3px !important;
}
pre {
    background-color: #161b22 !important;
    color: #79c0ff !important;
    padding: 16px !important;
    border-radius: 6px !important;
    border: 1px solid #30363d !important;
}
table {
    border-color: #30363d !important;
}
th {
    background-color: #161b22 !important;
}
</style>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>SSH HARDENING + FAIL2BAN</title></head><body><article id="3065e03f-0cac-80ea-a6c0-e2a23fa70847" class="page sans"><header><div class="page-header-icon undefined"><img class="icon notion-static-icon" src="https://www.notion.so/icons/server_lightgray.svg"/></div><h1 class="page-title" dir="auto"><strong>SSH HARDENING + FAIL2BAN</strong></h1><p class="page-description" dir="auto"></p></header><div class="page-body"><div style="display:contents" dir="auto"><h2 id="3065e03f-0cac-800a-b86a-ec37eb2fa0f5" class=""><strong>ШАГ 1: СОЗДАТЬ ПОЛЬЗОВАТЕЛЯ</strong></h2></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-8017-80c2-c159533b037a" class=""><strong>ЗАЧЕМ:</strong> Root — слишком мощный. Если хакер войдёт под root → он получит полный контроль.</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-80bb-b6f2-fc5356af5108" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all"># Создать пользователя sshuser
useradd -m -s /bin/bash sshuser

# Установить пароль
passwd sshuser</code></pre></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-8000-8f4a-d90f2424d957" class=""><strong>Введёшь пароль:</strong> <code>P@ssw0rd</code></p></div><div style="display:contents" dir="auto"><h2 id="3065e03f-0cac-8086-8f77-ff8fef8b3038" class=""><strong>ШАГ 2: НАСТРОИТЬ SSH</strong></h2></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-80df-9fe2-c70adc73800e" class=""><strong>ЗАЧЕМ:</strong> Запретить вход root, разрешить только sshuser.</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-80cf-ba31-e9ba3a7e0b83" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all"># Открыть конфиг SSH
nano /etc/ssh/sshd_config</code></pre></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-8091-aca5-e18d3fe20ff9" class=""><strong>НАЙДИ И ИЗМЕНИ:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-80da-a6f7-f2aee45d8234" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">PermitRootLogin no
AllowUsers sshuser</code></pre></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-8005-9667-f7ed38f94241" class=""><strong>Перезапустить SSH:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-8060-8423-f1705ec10b72" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">systemctl restart sshd</code></pre></div><div style="display:contents" dir="auto"><h2 id="3065e03f-0cac-80fd-bca5-fc849706d3b1" class=""><strong>ШАГ 3: УСТАНОВИТЬ FAIL2BAN</strong></h2></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-80be-8d48-f170db60d40f" class=""><strong>ЗАЧЕМ:</strong> Автоматически блокировать тех, кто неправильно ввёл пароль 2 раза.</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-8072-8a24-fa11cb41f3f9" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all"># Установить
apt update
apt install -y fail2ban</code></pre></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-8061-b134-d0174532eacd" class=""><strong>Создать конфиг:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-800d-b859-fd561b60a7b5" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">nano /etc/fail2ban/jail.local</code></pre></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-80cd-8ca5-c31451f99301" class=""><strong>ВСТАВЬ:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-807b-af33-fe7c71c8c17e" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">[DEFAULT]
bantime = 1m
maxretry = 2

[sshd]
enabled = true</code></pre></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-8018-b6c7-de230be51939" class=""><strong>ЧТО ЭТО ЗНАЧИТ:</strong></p></div><div style="display:contents" dir="auto"><ul id="3065e03f-0cac-80b7-af29-cad9d1bd386e" class="bulleted-list"><li style="list-style-type:disc"><code>bantime = 1m</code> → блокировать на 1 минуту</li></ul></div><div style="display:contents" dir="auto"><ul id="3065e03f-0cac-808d-9917-e12fc62a20c0" class="bulleted-list"><li style="list-style-type:disc"><code>maxretry = 2</code> → после 2 неудачных попыток</li></ul></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-80b9-851a-c4901884c306" class=""><strong>Запустить:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-8003-a151-e5ff8fce9cf0" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">systemctl enable fail2ban
systemctl start fail2ban</code></pre></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-80de-ab02-d2b0b1a2b641" class=""><strong>Проверить, что работает:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-80dc-896d-ff1f7c947fc3" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">fail2ban-client status sshd</code></pre></div><div style="display:contents" dir="auto"><h2 id="3065e03f-0cac-802d-a19c-cd7f1a447f49" class=""><strong>ШАГ 4: ЛОГИРОВАНИЕ SSH (AUDITD)</strong></h2></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-803d-b0f5-c954c48bc45c" class=""><strong>ЗАЧЕМ:</strong> Записывать, кто и когда подключался по SSH.</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-80e6-9905-cf528f12ee48" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all"># Установить
apt install -y auditd</code></pre></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-8036-8acb-d1d4db2b613d" class=""><strong>Добавить правила:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-80ff-9bde-d6ee0798dcd7" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">nano /etc/audit/rules.d/ssh.rules</code></pre></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-80e3-84b4-c26c3d519eb9" class=""><strong>ВСТАВЬ:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-80ef-9b30-de1eea591e8b" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">-w /usr/sbin/sshd -p x -k ssh_exec
-w /etc/ssh/sshd_config -p wa -k ssh_config</code></pre></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-80fd-bbd8-d04e9f15d908" class=""><strong>ЧТО ЭТО ЗНАЧИТ:</strong></p></div><div style="display:contents" dir="auto"><ul id="3065e03f-0cac-80f7-9650-c65850f90fab" class="bulleted-list"><li style="list-style-type:disc"><code>w /usr/sbin/sshd</code> → следить за программой SSH</li></ul></div><div style="display:contents" dir="auto"><ul id="3065e03f-0cac-8003-83ed-c956594a514a" class="bulleted-list"><li style="list-style-type:disc"><code>p x</code> → логировать запуск (execute)</li></ul></div><div style="display:contents" dir="auto"><ul id="3065e03f-0cac-8078-b587-efe81c954b2a" class="bulleted-list"><li style="list-style-type:disc"><code>k ssh_exec</code> → метка для поиска в логах</li></ul></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-809f-8838-d2b55fbdec58" class=""><strong>Перезапустить:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-8087-b727-faeafb2bc94a" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">systemctl restart auditd</code></pre></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-802b-9440-ef54316d1f37" class=""><strong>Посмотреть логи:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3065e03f-0cac-80d3-8922-fa1d8717e901" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">ausearch -k ssh_exec</code></pre></div><div style="display:contents" dir="auto"><p id="3065e03f-0cac-8002-a359-d2e239d5783a" class="">
</p></div></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body></html>